local applications = {
  "/csos/cfg/nightalarm",
  "/csos/demo/nightalarm",
  "/csos/lib/req-advterm",
  "/csos/lib/req-advtime",
  "/csos/lib/req-nightalarm",
  "/csos/lib/req-speaker",
  "/csos/lib/req-tick",
  "/install-nightalarm"
}

local doneStepsCount = 0
local totalStepsCount = #applications + 2
local function DrawProgressBar()
  local cursorX, cursorY = term.getCursorPos()
  term.setCursorPos(1,1)
  term.clearLine()
  termTextColor = term.getTextColor()
  term.setTextColor(colors.green)
  write("CS-OS Installation")
  term.setTextColor(termTextColor)
  term.setCursorPos(1,2)
  term.clearLine()
  term.setCursorPos(1,3)
  term.clearLine()
  local string = "["
  while string:len() < (doneStepsCount + 1) do string = string .. "|" end
  while string:len() < (totalStepsCount + 1) do string = string .. "." end
  string = string .. "]"
  print(string)
  term.setCursorPos(1,4)
  term.clearLine()
  term.setCursorPos(cursorX, cursorY)
end
local function TickProgressBar()
  doneStepsCount = doneStepsCount + 1
  DrawProgressBar()
end
local function RedrawWindow()
  term.clear()
  DrawProgressBar()
  term.setCursorPos(1,5)
end

RedrawWindow()

local deleteOld = false
if fs.exists("/csos") then
  print("There is another version of CS-OS on your computer.")
  print()
  print("Owerwrite it? ( Y / N )")
  print()
  write("> ")
  answer = read()
  if answer ~= "Y" then print() print("- Installation stopped") return end
  deleteOld = true
end
TickProgressBar()

RedrawWindow()

if deleteOld then
  print("- Deleting old version")
  fs.delete("/csos/")
  if fs.exists("/startup") then
    fs.delete("/startup.backup")
    fs.move("/startup", "/startup.backup")
  end
  sleep(0.05)
end
TickProgressBar()

local lastRedirectOutput = nil
local function RedirectOutput(string)
  lastRedirectOutput = string or "NOSTRING"
end
local function DoNothing() end

for _,app in ipairs(applications) do
  print("- Installing " .. app)
  DrawProgressBar()
  local oldWrite = term.write
  local oldSetCursorPos = term.setCursorPos
  local oldScroll = term.scroll
  term.write = RedirectOutput
  term.setCursorPos = DoNothing
  term.scroll = DoNothing
  local cursorX, cursorY = term.getCursorPos()
  fs.makeDir(fs.getDir(app) or "")
  shell.run("wget https://raw.githubusercontent.com/polyakov-alexey/minecraft-cs-os/main" .. app .. " " .. app)
  term.write = oldWrite
  term.setCursorPos = oldSetCursorPos
  term.setCursorPos(cursorX, cursorY)
  term.scroll = oldScroll

  if lastRedirectOutput == "Failed." then
    termTextColor = term.getTextColor()
    term.setTextColor(colors.red)
    print("# ERROR during download " .. app)
    term.setTextColor(termTextColor)
    sleep(1)
    print("- Installation stopped")
    return
  end

  sleep(0.1)
  TickProgressBar()
end

print("- Done")
